<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- CSP FIX: Add 'unsafe-inline' to script-src to allow inline JavaScript -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https://cdn.tailwindcss.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; connect-src 'self' *;">

    <title>Tennis Arbitrage Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple spinner animation */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            width: 24px;
            height: 24px;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col items-center p-4 sm:p-6">

    <div class="w-full max-w-4xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-indigo-600 dark:text-indigo-400">Tennis Arbitrage Finder</h1>
            <p class="mt-2 text-lg text-gray-600 dark:text-gray-400">Find guaranteed profit in tennis match odds across AU bookmakers. This is strictly a technical proof of concept/test and not financial advice</p>
        </header>

        <!-- Controls Section -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg mb-8">
            <!-- Main Action Button -->
            <div class="w-full">
                <button id="fetchSportsBtn" class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:focus:ring-offset-gray-800 transition-colors duration-200 flex items-center justify-center text-lg">
                    <span id="fetchSportsText">1. Get Available Tournaments</span>
                    <div id="fetchSportsSpinner" class="spinner hidden ml-2"></div>
                </button>
            </div>
            <!-- Dynamic Controls for Tournament Selection and Analysis -->
            <div id="tournamentControls" class="hidden mt-6 grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                 <!-- Tournament Select -->
                <div>
                    <label for="tournamentSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select Tournament</label>
                    <select id="tournamentSelect" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></select>
                </div>
                <!-- Find Opportunities Button -->
                <div>
                     <button id="findOddsBtn" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 dark:focus:ring-offset-gray-800 transition-colors duration-200 flex items-center justify-center">
                        <span id="findOddsText">2. Find Arbitrage</span>
                        <div id="findOddsSpinner" class="spinner hidden ml-2"></div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <main id="results" class="space-y-6">
            <!-- Message area for instructions, errors, or no results -->
            <div id="messageArea" class="text-center p-8 bg-white dark:bg-gray-800 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300">Welcome!</h3>
                <p class="mt-2 text-gray-500 dark:text-gray-400">
                    Click the button above to start searching for arbitrage opportunities.
                </p>
            </div>
            <!-- Arbitrage opportunities will be injected here -->
        </main>

        <!-- Footer -->
        <footer class="text-center mt-12 text-sm text-gray-500 dark:text-gray-400">
            <p>This is strictly a technical proof of concept/test and not financial advice. Always verify odds on the bookmaker's site before placing any bets.</p>
            <p class="mt-1">Not affiliated with any betting provider. Created by <a href="https://arronmong.github.io/">Arron M</a></p>
        </footer>
    </div>

    <script type="module">
        // --- DOM Element References ---
        const fetchSportsBtn = document.getElementById('fetchSportsBtn');
        const fetchSportsText = document.getElementById('fetchSportsText');
        const fetchSportsSpinner = document.getElementById('fetchSportsSpinner');
        
        const tournamentControls = document.getElementById('tournamentControls');
        const tournamentSelect = document.getElementById('tournamentSelect');
        const findOddsBtn = document.getElementById('findOddsBtn');
        const findOddsText = document.getElementById('findOddsText');
        const findOddsSpinner = document.getElementById('findOddsSpinner');

        const resultsContainer = document.getElementById('results');
        const messageArea = document.getElementById('messageArea');

        // --- API Configuration ---
        // The base URL now points to our own serverless function endpoint.
        const API_PROXY_URL = '/api/proxy'; 

        // --- Event Listeners ---
        fetchSportsBtn.addEventListener('click', handleFetchSports);
        findOddsBtn.addEventListener('click', handleFindArbitrage);
        
        // --- Functions ---

        /**
         * Fetches available tennis sports (tournaments) from our backend proxy
         * and populates the dropdown select.
         */
        async function handleFetchSports() {
            console.log('Button clicked - starting fetch...');
            setLoadingState(fetchSportsBtn, fetchSportsText, fetchSportsSpinner, true);
            showMessage('info', 'Fetching Tournaments...', 'Please wait while we get the list of active tennis tournaments.');

            try {
                // Call our own backend, which will securely use the API key.
                console.log('Making fetch request to:', API_PROXY_URL + '?endpoint=sports');
                const response = await fetch(`${API_PROXY_URL}?endpoint=sports`);
                console.log('Response received:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }

                const sports = await response.json();
                console.log('Sports data received:', sports);
                const tennisSports = sports.filter(sport => sport.group === 'Tennis' && sport.active);
                console.log('Tennis sports filtered:', tennisSports.length);

                if (tennisSports.length === 0) {
                    showMessage('info', 'No Active Tournaments', 'No active tennis tournaments were found at the moment. Please try again later.');
                    tournamentControls.classList.add('hidden');
                    return;
                }

                tournamentSelect.innerHTML = tennisSports
                    .map(sport => `<option value="${sport.key}">${sport.title}</option>`)
                    .join('');
                
                // Hide the initial button and show the tournament controls
                fetchSportsBtn.classList.add('hidden');
                tournamentControls.classList.remove('hidden');
                messageArea.classList.add('hidden');
                resultsContainer.innerHTML = '';

            } catch (error) {
                console.error('Error fetching sports:', error);
                showMessage('error', 'Failed to Fetch Tournaments', `Could not retrieve data. Reason: ${error.message}. Please check the server logs.`);
                tournamentControls.classList.add('hidden');
            } finally {
                setLoadingState(fetchSportsBtn, fetchSportsText, fetchSportsSpinner, false);
            }
        }

        /**
         * Fetches odds for the selected tournament via our backend and finds arbitrage.
         */
        async function handleFindArbitrage() {
            const sportKey = tournamentSelect.value;
            if (!sportKey) return;

            console.log('Finding arbitrage for sport:', sportKey);
            setLoadingState(findOddsBtn, findOddsText, findOddsSpinner, true);
            showMessage('info', 'Analyzing Odds...', 'Fetching match odds and searching for arbitrage opportunities. This may take a moment.');

            try {
                // Call our backend proxy with the selected sport key.
                const url = `${API_PROXY_URL}?endpoint=odds&sport=${sportKey}`;
                console.log('Making fetch request to:', url);
                const response = await fetch(url);
                console.log('Odds response received:', response.status, response.statusText);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }

                const oddsData = await response.json();
                console.log('Odds data received:', oddsData);
                const opportunities = findArbitrageOpportunities(oddsData);
                console.log('Arbitrage opportunities found:', opportunities.length);

                displayResults(opportunities);

            } catch (error) {
                console.error('Error finding arbitrage:', error);
                showMessage('error', 'Failed to Analyze Odds', `Could not retrieve odds. Reason: ${error.message}. The API key on the server might have reached its usage limit.`);
            } finally {
                setLoadingState(findOddsBtn, findOddsText, findOddsSpinner, false);
            }
        }

        /**
         * Processes the odds data to find arbitrage opportunities.
         * @param {Array} matches - The array of match data from the API.
         * @returns {Array} - An array of found arbitrage opportunity objects.
         */
        function findArbitrageOpportunities(matches) {
            const opportunities = [];

            if (!Array.isArray(matches)) {
                console.error("Expected 'matches' to be an array, but received:", matches);
                return opportunities;
            }

            for (const match of matches) {
                const player1 = match.home_team;
                const player2 = match.away_team;

                let bestOdds1 = { bookie: '', price: 0 };
                let bestOdds2 = { bookie: '', price: 0 };

                for (const bookmaker of match.bookmakers) {
                    const h2hMarket = bookmaker.markets.find(m => m.key === 'h2h');
                    if (!h2hMarket) continue;

                    const outcome1 = h2hMarket.outcomes.find(o => o.name === player1);
                    const outcome2 = h2hMarket.outcomes.find(o => o.name === player2);

                    if (outcome1 && outcome1.price > bestOdds1.price) {
                        bestOdds1 = { bookie: bookmaker.title, price: outcome1.price };
                    }
                    if (outcome2 && outcome2.price > bestOdds2.price) {
                        bestOdds2 = { bookie: bookmaker.title, price: outcome2.price };
                    }
                }

                if (bestOdds1.price > 0 && bestOdds2.price > 0) {
                    const margin = (1 / bestOdds1.price) + (1 / bestOdds2.price);

                    if (margin < 1) {
                        const profitPercentage = (1 - margin) * 100;
                        opportunities.push({
                            match: `${player1} vs ${player2}`,
                            player1,
                            player2,
                            bestOdds1,
                            bestOdds2,
                            margin,
                            profitPercentage,
                            id: match.id,
                        });
                    }
                }
            }
            return opportunities;
        }

        /**
         * Renders the found opportunities or a "no results" message to the UI.
         * @param {Array} opportunities - The array of opportunity objects.
         */
        function displayResults(opportunities) {
            resultsContainer.innerHTML = ''; // Clear previous results
            messageArea.classList.add('hidden');

            if (opportunities.length === 0) {
                showMessage('info', 'No Arbitrage Found', 'We analyzed the odds for the selected tournament but found no arbitrage opportunities at this time.');
                return;
            }

            opportunities.forEach(opp => {
                const card = document.createElement('div');
                card.className = 'bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg';
                card.innerHTML = `
                    <div class="border-b border-gray-200 dark:border-gray-700 pb-4 mb-4">
                        <h3 class="text-xl font-bold text-indigo-600 dark:text-indigo-400">${opp.match}</h3>
                        <p class="text-green-500 font-semibold mt-1">Guaranteed Profit: ${opp.profitPercentage.toFixed(3)}%</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <!-- Bet on Player 1 -->
                        <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600 dark:text-gray-400">Bet on: <span class="font-bold text-lg text-gray-900 dark:text-gray-100">${opp.player1}</span></p>
                            <p class="text-sm mt-2">Best Odds: <span class="font-bold text-2xl text-indigo-500">${opp.bestOdds1.price.toFixed(2)}</span></p>
                            <p class="text-sm">Bookmaker: <span class="font-semibold">${opp.bestOdds1.bookie}</span></p>
                        </div>
                        <!-- Bet on Player 2 -->
                        <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600 dark:text-gray-400">Bet on: <span class="font-bold text-lg text-gray-900 dark:text-gray-100">${opp.player2}</span></p>
                            <p class="text-sm mt-2">Best Odds: <span class="font-bold text-2xl text-indigo-500">${opp.bestOdds2.price.toFixed(2)}</span></p>
                            <p class="text-sm">Bookmaker: <span class="font-semibold">${opp.bestOdds2.bookie}</span></p>
                        </div>
                    </div>
                    
                    <!-- Calculator Section -->
                    <div class="bg-indigo-50 dark:bg-indigo-900/30 p-4 rounded-lg">
                        <h4 class="font-semibold text-lg mb-3 text-center">Profit Calculator</h4>
                        <div class="flex flex-col sm:flex-row items-center gap-4">
                            <div class="w-full sm:w-1/3">
                                <label for="stake-${opp.id}" class="block text-sm font-medium mb-1">Total Stake ($)</label>
                                <input type="number" id="stake-${opp.id}" class="w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="e.g., 100">
                            </div>
                            <div class="w-full sm:w-2/3 grid grid-cols-1 sm:grid-cols-3 gap-2 text-center">
                                <div>
                                    <p class="text-xs sm:text-sm font-medium text-gray-600 dark:text-gray-400">Bet on ${opp.player1}</p>
                                    <p id="bet1-${opp.id}" class="font-bold text-lg text-gray-900 dark:text-gray-100">$0.00</p>
                                </div>
                                <div>
                                    <p class="text-xs sm:text-sm font-medium text-gray-600 dark:text-gray-400">Bet on ${opp.player2}</p>
                                    <p id="bet2-${opp.id}" class="font-bold text-lg text-gray-900 dark:text-gray-100">$0.00</p>
                                </div>
                                <div>
                                    <p class="text-xs sm:text-sm font-medium text-green-600 dark:text-green-400">Guaranteed Profit</p>
                                    <p id="profit-${opp.id}" class="font-bold text-lg text-green-600 dark:text-green-400">$0.00</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                resultsContainer.appendChild(card);

                const stakeInput = document.getElementById(`stake-${opp.id}`);
                stakeInput.addEventListener('input', (e) => calculateStake(e, opp));
            });
        }

        /**
         * Calculates and displays the individual bet amounts and profit based on a total stake.
         * @param {Event} event - The input event from the stake field.
         * @param {Object} opp - The opportunity object containing odds and margin info.
         */
        function calculateStake(event, opp) {
            const totalStake = parseFloat(event.target.value) || 0;
            const { bestOdds1, bestOdds2, margin, id } = opp;

            const bet1Elem = document.getElementById(`bet1-${id}`);
            const bet2Elem = document.getElementById(`bet2-${id}`);
            const profitElem = document.getElementById(`profit-${id}`);

            if (totalStake <= 0) {
                bet1Elem.textContent = '$0.00';
                bet2Elem.textContent = '$0.00';
                profitElem.textContent = '$0.00';
                return;
            }

            const bet1Amount = (totalStake / margin) / bestOdds1.price;
            const bet2Amount = (totalStake / margin) / bestOdds2.price;
            const profit = (totalStake / margin) - totalStake;

            bet1Elem.textContent = `$${bet1Amount.toFixed(2)}`;
            bet2Elem.textContent = `$${bet2Amount.toFixed(2)}`;
            profitElem.textContent = `$${profit.toFixed(2)}`;
        }


        /**
         * Toggles the loading state of a button.
         * @param {HTMLElement} button - The button element.
         * @param {HTMLElement} text - The text span inside the button.
         * @param {HTMLElement} spinner - The spinner div inside the button.
         * @param {boolean} isLoading - The desired loading state.
         */
        function setLoadingState(button, text, spinner, isLoading) {
            if (isLoading) {
                button.disabled = true;
                text.classList.add('hidden');
                spinner.classList.remove('hidden');
            } else {
                button.disabled = false;
                text.classList.remove('hidden');
                spinner.classList.add('hidden');
            }
        }

        /**
         * Displays a message in the main content area.
         * @param {'info'|'error'} type - The type of message.
         * @param {string} title - The title of the message.
         * @param {string} body - The body content of the message.
         */
        function showMessage(type, title, body) {
            const titleColor = type === 'error' 
                ? 'text-red-500 dark:text-red-400' 
                : 'text-gray-700 dark:text-gray-300';
            
            messageArea.innerHTML = `
                <h3 class="text-xl font-semibold ${titleColor}">${title}</h3>
                <p class="mt-2 text-gray-500 dark:text-gray-400">${body}</p>
            `;
            messageArea.classList.remove('hidden');
            resultsContainer.innerHTML = ''; // Clear any existing results
        }

    </script>
</body>
</html>